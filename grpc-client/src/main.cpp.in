// Copyright 2019 GSI, Inc. All rights reserved.
//
//

#include "GrpcControlClient.h"

// BOOST
#include <boost/program_options/options_description.hpp>
#include <boost/program_options/parsers.hpp>
#include <boost/program_options/variables_map.hpp>

using namespace std;
namespace bpo = boost::program_options;

void printDescription()
{
    cout << "Sample client for DDS control." << endl
         << "Available commands:" << endl
         << ".quit - Quit the program." << endl
         << ".init - Initialization request." << endl
         << ".config - Configure run request." << endl
         << ".start - Start request." << endl
         << ".stop - Stop request." << endl
         << ".term - Terminate request." << endl
         << ".down - Shutdown request." << endl
         << ".update - Update topology request." << endl;
}

int main(int argc, char** argv)
{
    string host;
    string topo;
    string updatedTopo;

    // Generic options
    bpo::options_description options("grpc-sample-client options");
    options.add_options()("help,h", "Produce help message");
    options.add_options()("host",
                          bpo::value<std::string>(&host)->default_value("localhost:50051"),
                          "DDS control connection string (default \"localhost:50051\")");
    string defaultTopo("@FairMQ_DATADIR@/ex-dds-topology-infinite.xml");
    options.add_options()("topo",
                          bpo::value<std::string>(&topo)->default_value(defaultTopo),
                          (string("Topology filepath (default ") + defaultTopo + string(")")).c_str());
    options.add_options()("utopo",
                          bpo::value<std::string>(&updatedTopo)->default_value(defaultTopo),
                          (string("Updated topology filepath (default ") + defaultTopo + string(")")).c_str());

    // Parsing command-line
    bpo::variables_map vm;
    bpo::store(bpo::command_line_parser(argc, argv).options(options).run(), vm);
    bpo::notify(vm);

    if (vm.count("help"))
    {
        cout << options;
        return EXIT_SUCCESS;
    }

    CGrpcControlClient control(grpc::CreateChannel(host, grpc::InsecureChannelCredentials()));

    // TODO: FIXME: Think of a better design on how to avoid code dublication.
    printDescription();

    while (true)
    {
        string cmd;
        cout << "Please enter command: ";
        getline(std::cin, cmd);

        string replyString;

        if (cmd.empty())
        {
        }
        else if (cmd == ".quit")
        {
            return EXIT_SUCCESS;
        }
        else if (cmd == ".init")
        {
            cout << "Sending initialization request..." << endl;
            replyString = control.RequestInitialize(topo);
        }
        else if (cmd == ".config")
        {
            cout << "Sending configure run request..." << endl;
            replyString = control.RequestConfigureRun();
        }
        else if (cmd == ".start")
        {
            cout << "Sending start request..." << endl;
            replyString = control.RequestStart();
        }
        else if (cmd == ".stop")
        {
            cout << "Sending stop request..." << endl;
            replyString = control.RequestStop();
        }
        else if (cmd == ".term")
        {
            cout << "Sending terminate request..." << endl;
            replyString = control.RequestTerminate();
        }
        else if (cmd == ".down")
        {
            cout << "Sending shutdown request..." << endl;
            replyString = control.RequestShutdown();
        }
        else if (cmd == ".update")
        {
            cout << "Sending update topology request..." << endl;
            replyString = control.RequestUpdateTopology(updatedTopo);
        }
        else
        {
            cout << "Unknown command " << cmd << endl;
        }

        if (!replyString.empty())
        {
            cout << "Reply: " << replyString << endl;
        }
    }

    return EXIT_SUCCESS;
}
